{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='lib/bootstrap-table.min.css') }}"
      xmlns="http://www.w3.org/1999/html">
{{super()}}
{% endblock %}

{% block content %}
<br>
<br>
<div class="container">
    <div id="query_files"></div>
    <div class="row">
        <div class="col py-3 border bg-light">
            <b>Select project</b>
                <select name="project" id="project">
                    {% if projects %}
                      {% for project_id, project_name in projects %}
                        {% if project_id == cur_project_id %}
                          <option selected value="{{ project_id }}">{{ project_name }}</option>
                        {% else %}
                          <option value="{{ project_id }}">{{ project_name }}</option>
                        {% endif %}
                      {% endfor %}
                  {% endif %}
                </select>
        </div>
    </div>
    <div class="row">
        <div class="col py-3 border bg-light">
            <b>Select survey</b>
                <select name="survey" id="survey">
                    {% if surveys %}
                      {% for survey_run in surveys %}
                        {% if survey_run == cur_project_id %}
                          <option selected value="{{ survey_run }}">{{ survey_run }}</option>
                        {% else %}
                          <option value="{{ survey_run }}">{{ survey_run }}</option>
                        {% endif %}
                      {% endfor %}
                  {% endif %}
                </select>
        </div>
    </div>
    <br>
    <button onclick="fetchFiles()" id="query" name="query" class="btn btn-primary">Submit</button>
    <button onclick="downloadFiles()" id="download" name="download" class="btn btn-primary" type="button" disabled>Download</button>
    <br>
</div>
<br>
<div class="container">
    <table
            id="logtable">
        <thead>
          <tr>
            <th data-field="device_uuid" data-sortable="true">Device uuid</th>
            <th data-field="photo_filename" data-sortable="true">File name</th>
            <th data-field="survey_run" data-sortable="true">Survey run</th>
<!--            <th data-field="actions" data-formatter="actionFormatter" data-events="operateEvents">actions</th>-->
          </tr>
        </thead>
      </table>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script type="text/javascript" src="{{ url_for('static', filename='lib/bootstrap-table.min.js') }}" charset="utf-8"></script>
<script>
var photos;
function loadTable()
{
    $(function () {
          $('#logtable').bootstrapTable({
              pagination: true,
              pageList: [10, 15, 20, 50, 100],
              pageSize: 10,
              pageNumber: 1
          });
    });
}
function fetchFiles(){
    $.getJSON(
        "_files",
        {
            project_id: $('#project').val()
        },
        function(data){
            $('#logtable').bootstrapTable("load", data);
            if(data.length > 0)
            {
                photos = JSON.stringify(data);
                // make download button active if data is received
                document.getElementById("download").disabled = false
            }
        }
    );
}
function downloadFiles(){
    // redirect to download page
    var url = '/odm360.zip?photos=' + photos
    window.location.replace(url)
}
loadTable();
</script>
{% endblock %}
