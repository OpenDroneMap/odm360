{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='lib/bootstrap-table.min.css') }}">
{{super()}}
<link rel="stylesheet" href="{{ url_for('static', filename='lib/buttons.css') }}">
{% endblock %}

{% block content %}

<div class="container">
    <table id="table">
        <thead>
          <tr>
            <th data-field="device_no" data-sortable="true">Device no.</th>
            <th data-field="device_uuid" data-sortable="true">Device uuid</th>
            <th data-field="device_name" data-sortable="true">Device name</th>
<!--            <th data-field="ip" data-sortable="true">IP address</th>-->
            <th data-field="status" data-sortable="true">Status</th>
            <th data-field="last_photo" data-sortable="true">Last photo</th>
<!--            <th data-field="actions" data-formatter="actionFormatter" data-events="operateEvents">actions</th>-->
          </tr>
        </thead>
      </table>
</div>
<br>
<br>
<!--<form id="broadcast" method="POST" action='#'>-->
<!--    <input type="text" name="broadcast_data" id="broadcast_data" placeholder="Message">-->
<!--    <input type="submit" value="Broadcast">-->
<!--</form>-->
<!--<h2>Receive:</h2>-->
<!--<div id="log"></div>-->
<div class="container">
    <div id="bar-chart"></div>
        <div class="row">
            <div class="col py-3 border bg-light">
                <b>Select project</b>
                <form action="" method="POST">
                    <select class="btn btn-primary dropdown-toggle" name="project" id="project">
                        {% if projects %}
                          {% for project_id, project_name in projects %}
                            {% if project_id == cur_project_id %}
                              <option selected value="{{ project_id }}">{{ project_name }}</option>
                            {% else %}
                              <option value="{{ project_id }}">{{ project_name }}</option>
                            {% endif %}
                          {% endfor %}
                      {% endif %}
                    </select>
                </form>
            </div>
            <div class="col py-3 border bg-light">
                <b>Main service:</b>
                <form action="" method="POST">
                    <label class="switch">
                        {% if service_active==3 %}
                          <input name="service" id="service" type="checkbox" checked>
                        {% else %}
                          <input name="service" id="service" type="checkbox">
                        {% endif %}
                      <span class="slider round"></span>
                    </label>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div style="overflow:auto; height:auto; width:auto">
        <img id="streamed-image" src="">  <!--  width="360px" height="200px" -->
    </div>
    <div class="contents">
        <button id='play-btn'>PLAY</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{super()}}
<script type="text/javascript" src="{{ url_for('static', filename='lib/bootstrap-table.min.js') }}" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='lib/socket.io.min.js') }}" charset="utf-8"></script>
<script>
    function loadTable()
    {
        $(function () {
          $('#table').bootstrapTable({
          });
        });
    }
    function fetchdevices(){
        $.getJSON(
            "_cameras",
            function(data){
                $('#table').bootstrapTable("load",
                data
                );
            }
        );
    }
    loadTable();
    setInterval(fetchdevices, 1000);
</script>
<script>
$(document).ready(function(){
    var url = 'http://' + document.domain + ':' + location.port + '/test'
    console.log(url)
    var socket = io.connect(url);
    socket.on('my response', function(msg) {
        $('#log').append('<p>Received: ' + msg.data + '</p>');
    });
    socket.on('stream_response', (msg) => {
            document.querySelector('#streamed-image').src = msg.image;
        });
    $('form#emit').submit(function(event) {
        socket.emit('my event', {data: $('#emit_data').val()});
        return false;
    });
    $('form#broadcast').submit(function(event) {
        socket.emit('my broadcast event', {data: $('#broadcast_data').val()});
        return false;
    });
    document.querySelector('#play-btn').addEventListener('click', () => {
        socket.emit('request_video', {});
    });
    window.addEventListener("beforeunload", function (event) {
        socket.disconnect()
    });
});

</script>
{% endblock %}